SELECT *  FROM SR4100
WHERE D_E_L_E_T_ <> '*'
AND R4_ANO = '2019'
AND R4_FILIAL = '10'
AND R4_CODRET NOT IN ('5952','5960','5979')


UPDATE SR4100
SET D_E_L_E_T_ = '*', R_E_C_D_E_L_ = R_E_C_N_O_
WHERE D_E_L_E_T_ <> '*'
AND R4_ANO = '2020'
AND R4_CODRET NOT IN ('5952','5960','5979')

/*
Códigos de retenção que devem ser gerados pela emissão

1708
3208
3280

Códigos de retenção que devem ser gerados pelo vencimento 

5952
5960
5979

1- Localizar todos os títulos que são "candidatos" a estar na DIRF:

Os títulos principais que possuem retenção de impostos federais deverão possuir código de retenção, verificamos através da consulta abaixo os seguintes campos: 
E2_DTDIRF, E2_CODRET, E2_DIRF

SELECT E2_CODRET,SUBSTRING(E2_EMISSAO,5,2) MESBASE ,E2_PREFIXO, E2_NUM ,E2_DTDIRF, E2_CODRET, E2_DIRF,
E2_PARCELA, E2_TIPO, E2_NATUREZ NATUREZA, E2_BASEPIS BASE , E2_PIS PIS , E2_COFINS COFINS ,E2_CSLL CSLL , E2_PIS+E2_COFINS+E2_CSLL SOMA 
FROM SE2010 SE2 
WHERE E2_TIPO IN ('NF','RC','FT','TX')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20210101' and '20211231'
AND E2_FILIAL = '01'
AND E2_PIS+E2_COFINS+E2_CSLL > 0



Para ir para a DIRF eles devem estar com o campo E2_DIRF = 1, E2_DTDIRF = '' e E2_CODRET tem que estar preenchido.

2- Inibir a geração dos títulos de impostos código de retenção PCC

SELECT E2_CODRET,SUBSTRING(E2_EMISSAO,5,2) MESBASE ,E2_PREFIXO, E2_NUM ,E2_DTDIRF, E2_CODRET, E2_DIRF,
E2_PARCELA, E2_TIPO, E2_NATUREZ NATUREZA, E2_BASEPIS BASE , E2_PIS PIS , E2_COFINS COFINS ,E2_CSLL CSLL , E2_PIS+E2_COFINS+E2_CSLL SOMA 
FROM SE2070 SE2 
WHERE E2_TIPO IN ('NF','RC','FT','TX')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20200101' and '20201231'
AND E2_FILIAL = '15'
AND E2_PIS+E2_COFINS+E2_CSLL > 0

update SE2070
SET  E2_DIRF = 1, E2_DTDIRF = ''
FROM SE2070 SE2 
WHERE E2_TIPO IN ('NF','RC','FT','TX')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20200101' and '20201231'
AND E2_FILIAL = '15'
AND E2_PIS+E2_COFINS+E2_CSLL > 0

*/

/*
Serviços ( Feira dentro do mesmo arquivo) 
Atendimento
Resgate 
SNN
Safecare
UNIX.

*/


SELECT E2_FORNECE, E2_FILIAL,E2_CODRET,SUBSTRING(E2_EMISSAO,5,2) MESBASE ,E2_PREFIXO, E2_NUM ,E2_DTDIRF,  E2_DIRF,
E2_PARCELA, E2_TIPO, E2_NATUREZ NATUREZA, E2_VALOR,E2_BASEPIS BASE  ,E2_IRRF,E2_PIS PIS , E2_COFINS COFINS ,E2_CSLL CSLL , E2_PIS+E2_COFINS+E2_CSLL SOMA 
FROM SE2070 SE2 
WHERE E2_TIPO IN ('NF','RC','FT')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20200101' and '20201231'
AND E2_PIS+E2_COFINS+E2_CSLL > 0
and E2_FILIAL = '15'
AND E2_CODRET = ''
ORDER BY E2_CODRET 

SELECT E2_CODRET, * FROM SE2010
WHERE E2_FILIAL = '10'
AND E2_FORNECE IN (
'000854',
'001273',
'002574',
'007707',
'008154',
'008271')


/*
UPDATE SE2070
SET E2_CODRET = '1708'
FROM SE2070 SE2 
WHERE E2_TIPO IN ('NF','RC','FT')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20200101' and '20201231'
AND E2_PIS+E2_COFINS+E2_CSLL > 0
and E2_FILIAL = '15'
AND E2_CODRET = ''
*/

SELECT E2_DTDIRF, E2_CODRET, E2_DIRF,* FROM SE2010 SE2
WHERE E2_TIPO = 'TX'
AND SE2.D_E_L_E_T_ <> '*'
AND E2_NATUREZ = '2103001   '
and E2_EMISSAO between '20210101' and '20211231'
and E2_FILIAL = '01'
AND E2_TITPAI IN (
SELECT E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA
FROM SE2070 SE2 
WHERE E2_TIPO IN ('NF','RC','FT')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20200101' and '20201231'
AND E2_PIS+E2_COFINS+E2_CSLL > 0
and E2_FILIAL = '15'
AND E2_CODRET = '3280'
)

UPDATE SE2010
SET E2_CODRET = '3280', E2_DIRF = '1'
WHERE E2_TIPO = 'TX'
AND D_E_L_E_T_ <> '*'
AND E2_NATUREZ = '2103001   '
and E2_EMISSAO between '20210101' and '20211231'
--and E2_FILIAL = '15'
AND E2_TITPAI IN (
SELECT E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA
FROM SE2010 SE2 
WHERE E2_TIPO IN ('NF','RC','FT')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20210101' and '20211231'
AND E2_PIS+E2_COFINS+E2_CSLL > 0
--and E2_FILIAL = '15'
AND E2_CODRET = '3280'
)


SELECT * FROM SR4070
WHERE R4_ANO = '2019'
and R4_FILIAL = '01'
AND R4_CODRET = '1708'
AND D_E_L_E_T_ = ''



/*
SELECT ED_CODRET, E2_CODRET,* 
FROM SE2100 SE2 JOIN SED100 SED ON (ED_CODIGO = E2_NATUREZ )
WHERE ED_CODRET <> ''
AND SE2.D_E_L_E_T_ = ''
AND SED.D_E_L_E_T_ = ''
AND E2_CODRET = ''
order by E2_EMISSAO 



UPDATE SE2010
SET E2_CODRET = ED_CODRET
FROM SE2010 SE2 JOIN SED010 SED ON (ED_CODIGO = E2_NATUREZ )
WHERE ED_CODRET <> ''
AND SE2.D_E_L_E_T_ = ''
AND SED.D_E_L_E_T_ = ''
AND E2_CODRET = ''




SELECT DISTINCT E2_NATUREZ
FROM SE2100 SE2 
WHERE E2_TIPO IN ('NF','RC','FT')
AND SE2.D_E_L_E_T_ <> '*'
and E2_EMISSAO between '20210101' and '20211231'
AND E2_PIS+E2_COFINS+E2_CSLL > 0
and E2_FILIAL = '01'
and E2_CODRET = ''

SELECT ED_CODRET,* FROM SED100
WHERE ED_CODIGO IN (
'410808006', 
'410108001' 
)
AND D_E_L_E_T_ = ''


SELECT * FROM SED010 S10 
JOIN SED100 S100 ON (S10.ED_CODIGO = S100.ED_CODIGO )
WHERE S100.ED_CODRET = ''
AND S10.ED_CODRET <> ''

UPDATE SED100
SET ED_CODRET = S10.ED_CODRET
FROM SED010 S10 
JOIN SED100 S100 ON (S10.ED_CODIGO = S100.ED_CODIGO )
WHERE S100.ED_CODRET = ''
AND S10.ED_CODRET <> ''

SELECT ED_CODRET,* FROM SED100
WHERE ED_CODRET <> ''
 
*/


select E2_DTDIRF, E2_DIRF, E2_CODRET,* from SE2100
WHERE E2_FORNECE IN ('000090','000120','000211')
AND D_E_L_E_T_ = ''
--AND E2_TIPO = 'TX'
AND E2_EMISSAO BETWEEN '20200101' AND '20201231'

UPDATE SE2100
SET E2_DIRF = '1', E2_CODRET = '3208'
WHERE E2_NUM IN (
'SP250120',
'SP260220',
'SP250320',
'SP250420',
'SP250520',
'SP250620',
'SP250720',
'SP150720',
'SP250820',
'SP220920',
'SP250920',
'SP251020',
'SP051020',
'SP050121',
'SP301220',
'SP050121',
'SP291220',
'SP291220')
AND D_E_L_E_T_ = ''
AND E2_TIPO = 'TX'
AND E2_NATUREZ = '410608001 '